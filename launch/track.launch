<?xml version="1.0"?>

<launch>
    <arg name="obj_recognition_viewer_launch"                        default="true" />
    <arg name="obj_tracking_viewer_launch"                           default="true" />
    <arg name="rviz_launch"                                          default="true" />

    <!-- Arguments for camera launch file -->
    <!-- Arguments for launching Realsense camera -->
    <arg name="nodelet_manager"                                     default="nodelet_manager"/>
    <arg name="camera"                                              default="realsense" />

    <!-- Arguments for image tracking and point cloud extraction launch file -->
    <!-- Arguments for Image Tracker -->
    <arg name="tracker_image_source_topic"                          default="/$(arg camera)/color/image_raw" />
    <arg name="tracker_image_output_topic"                          default="/obj_tracking_image" />
    <arg name="tracker_type"                                        default="CSRT" />
    <arg name="tracker_bbox_topic"                                  default="/tracked_obj_bbox" />

    <!-- Arguments for Object Point Cloud Extraction -->
    <arg name="extractor_input_point_cloud_topic"                   default="/$(arg camera)/depth_registered/points" />
    <arg name="extractor_input_bbox_topic"                          default="$(arg tracker_bbox_topic)" />
    <arg name="extractor_output_point_cloud_topic"                  default="/tracked_object_point_cloud" />

    <!-- Arguments for PCL nodelets -->
    <arg name="pcl_nodelet_manager"                                 default="$(arg nodelet_manager)"/>
    <arg name="filter_axis"                                         default="z" />

    <!-- Arguments for point cloud tracking launch file -->
    <!-- Arguments for particle filter tracking -->
    <arg name="pf_tracker_reset_service"                            default="reset_particle_filter_tracker" />

    <!-- <arg name="pointcloud_template_pointcloud_filename"             default="$(find arm_vs)/dataset/mustard/mustard.pcd" /> -->
    <arg name="pointcloud_template_pointcloud_filename"             default="$(find arm_vs)/dataset/vitamin/vitamin_bottle.pcd" />
    <!-- <arg name="pointcloud_template_pointcloud_filename"             default="$(find arm_vs)/dataset/cal_mug/cal_mug_clean.pcd" /> -->

    <arg name="pf_trakcing_input_pointcloud"                        default="/$(arg camera)/voxel_grid/output" />
    <arg name="pf_tracked_pointcloud"                               default="/pf_tracked_pointcloud" />
    <arg name="pf_tracked_template_frame"                           default="particle_filter_tracked_template_frame" />

    <!-- Arguments for ICP alignment -->
    <arg name="icp_output_pointcloud"                               default="/aligned_pointcloud" />
    <arg name="icp_alignment_frame"                                 default="icp_alignment_frame" />

    <arg name="opencl_caffe_nodelet_manager"                        default="$(arg nodelet_manager)" />
    <arg name="opencl_caffe_nodelet"                                default="opencl_caffe_nodelet" />
    <arg name="opencl_caffe_viewer"                                 default="opencl_caffe_viewer" />
    <arg name="obj_inference_output_topic"                          default="/$(arg camera)/opencl_caffe/inference" />

    <!-- Launch Node and Nodelets -->

    <node pkg="tf2_ros" type="static_transform_publisher" name="camera_to_hand" 
        args="-0.0187845171388 0.0629403083384 -0.0936029139899
                -0.5111042314 0.499085936412 0.50680045647 0.482533926313 
                mico_link_hand $(arg camera)_link" />

    <node pkg="tf2_ros" type="static_transform_publisher" name="desired_camera_pose" 
        args="0 0 -0.4 0 0 0 1 particle_filter_tracked_template_frame desired_camera_pose" />

    <!-- Realsense camera launcher -->
    <include file="$(find realsense2_camera)/launch/rs_rgbd.launch"> 
        <arg name="manager"                     value="$(arg nodelet_manager)"/>
        <arg name="camera"                      value="$(arg camera)" />
    </include>

    <!-- Nodelets -->
    <group ns="$(arg camera)">
        
        <!-- opencl caffe object recognition nodelet -->
        <include file="$(find opencl_caffe_launch)/launch/includes/nodelet.launch">
            <arg name="name"                    value="$(arg opencl_caffe_nodelet)" />
            <arg name="manager"                 value="$(arg opencl_caffe_nodelet_manager)" />
            <arg name="input_topic"             value="$(arg tracker_image_source_topic)" />
            <arg name="output_topic"            value="$(arg obj_inference_output_topic)" />
        </include>
        
        <!-- nodelet for object recognition viewer -->
        <include file="$(find opencl_caffe_launch)/launch/includes/viewer.launch" if="$(arg obj_recognition_viewer_launch)">
            <arg name="name"                    value="$(arg opencl_caffe_viewer)" />
            <arg name="input_topic"             value="$(arg tracker_image_source_topic)" />
            <arg name="output_topic"            value="$(arg obj_inference_output_topic)" />
        </include>

        <!-- Run a VoxelGrid filter to clean NaNs and downsample the data -->
        <node name="voxel_grid" pkg="nodelet" type="nodelet" args="load pcl/VoxelGrid $(arg pcl_nodelet_manager)" output="screen">
            <remap from="~input"                to="$(arg extractor_output_point_cloud_topic)"/>
            <rosparam param="filter_field_name" subst_value="True">$(arg filter_axis)</rosparam>
            <rosparam>
                filter_limit_min: 0.01
                filter_limit_max: 1.5
                filter_limit_negative: False
                leaf_size: 0.005
            </rosparam>
        </node>

    </group>

    <!-- Image tracking and point cloud extraction launcher -->
    <include file="$(find arm_vs)/launch/track_and_extract_obj_pointcloud.launch"> 
        
        <arg name="tracker_image_source_topic"                  value="$(arg tracker_image_source_topic)" />
        <arg name="tracker_image_output_topic"                  value="$(arg tracker_image_output_topic)" />
        <arg name="tracker_type"                                value="$(arg tracker_type)" />
        <arg name="tracker_bbox_topic"                          value="$(arg tracker_bbox_topic)" />

        <arg name="inference_topic"                             value="$(arg obj_inference_output_topic)" />
        <arg name="tracked_frame_limit"                         value="15" />
        <arg name="missing_obj_frame_limit"                     value="15" />

        <arg name="extractor_input_point_cloud_topic"           value="$(arg extractor_input_point_cloud_topic)" />
        <arg name="extractor_input_bbox_topic"                  value="$(arg extractor_input_bbox_topic)" />
        <arg name="extractor_output_point_cloud_topic"          value="$(arg extractor_output_point_cloud_topic)" />

    </include>

    <!-- Particle filter based point cloud tracking luancher -->
    <include file="$(find arm_vs)/launch/track_and_align_obj_pointcloud.launch">
    
        <arg name="pf_tracker_reset_service"                        value="$(arg pf_tracker_reset_service)" />

        <arg name="pointcloud_template_pointcloud_filename"         value="$(arg pointcloud_template_pointcloud_filename)" />

        <arg name="pf_trakcing_input_pointcloud"                    value="$(arg pf_trakcing_input_pointcloud)" />
        <arg name="pf_tracked_pointcloud"                           value="$(arg pf_tracked_pointcloud)" />
        <arg name="pf_tracked_template_frame"                       value="$(arg pf_tracked_template_frame)" />

        <arg name="icp_output_pointcloud"                           value="$(arg icp_output_pointcloud)" />
        <arg name="icp_alignment_frame"                             value="$(arg icp_alignment_frame)" />

    </include>
    
    <node name="rviz" pkg="rviz" type="rviz" output="screen" if="$(arg rviz_launch)"/>

</launch>